---
title: Impacts of Tree Canopy Cover Percentage on the Rate of COVID Deaths per Positive Case
  in California
author: "Clarissa Boyajian"
date: "12/1/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

options(scipen = 999)

library(tidyverse)
library(lubridate)
library(janitor)
library(sf)
library(tmap)
library(patchwork)
library(broom)

##NOTES TO SELF:
  #include fig captions, make figures smaller, change layout of figures
  #put lm() into table
  #remove lm() output message
```


# What impact does the percentage of tree canopy cover have on the rate of COVID deaths (per confirmed positive case) in California?
This blog post will analyze the impact of tree canopy cover percentages on the likelihood of dying if COVID-19 is contracted at a county level throughout California. 


## Importance
This is an important and interesting environmental justice question to consider because tree canopy cover percentages and COVID-19 disproportionately impacted historically marginalized populations throughout the United States. Additionally, both are linked to respiratory and cardiovascular diseases. There is proven evidence (CITE) that areas with more urban tree canopy have increased public health indicators. This includes lower rates of disease such as asthma, strokes, and cardiac disease (CITE nature conservancy?). There is also evidence (CITE) that individuals with existing respiratory and/or cardiovascular disease are not only more likely to contract COVID-19, but also more likely to be sicker or even die. 


## Data

#### Tree Canopy Data

The tree canopy data used for this analysis is publicly available from the Public Health Alliance of Southern California (2), which reports California Healthy Places Indexes. The data is available in CSV format, with a canopy cover percentage for each census tract within California. The website was last updated in April of 2021, but the tree canopy data is from 2011. 

#### COVID-19 Data

The COVID-19 data used in this analysis was publicly available on the LA Times DataDesk GitHub repository (1). This data was collected using scrapers written in Python and Jupyter notebooks, scheduled and run via GitHub Actions, and archived using git. The scrapers collection data from the California Department of Public Health and other government agencies. This data is at a county-level spatial resolution and includes a daily number for both confirmed cases and deaths from February 1st, 2020 to today. The data used in this analysis included daily numbers from February 1st, 2020 through November 22, 2021. 

#### Geographic Data

The geographic data used in this analysis includes California county borders and U.S. Census regions, which subsets the state into 10 different regions. The county geographies were downloaded as a ShapeFile from the LA Times DataDesk GitHub repository (3). The U.S. Census regions were manually entered into R based on a map publicly available on the U.S. Census website (5). 

#### Income Data
The median income data used in this analysis was downloaded from the United States Department of Agriculture (USDA) Economic Research Service website (4). The median income data is aggregated to a county level and is from 2019, with the website last updated in June 2021. 

```{r Read in data, message=FALSE, warning=FALSE}
county_geom_raw <- st_read("map_data/counties.shp", quiet = TRUE)

income_raw <- read.csv("income_data/UnemploymentReport.csv")

tree_canopy_raw <- read_csv("tree_data/HPI-Individual-Indicators/HPI2_treecanopy.csv")

covid_raw_latimes <- read.csv("covid_data/cdph-county-cases-deaths.csv") # 2020-02-01 to 2021-11-22
```

```{r Wrangle county geom data, warning=FALSE}
county_region1 <- c("Butte", "Colusa", "El Dorado", "Glenn", "Lassen", "Modoc", 
                    "Nevada", "Placer", "Plumas", "Sacramento", "Shasta", 
                    "Sierra", "Siskiyou", "Sutter", "Tehama", "Yolo", "Yuba")
county_region2 <- c("Del Norte", "Humboldt", "Lake", "Mendocino", "Napa", 
                    "Sonoma", "Trinity")
county_region3 <- c("Alameda", "Contra Costa", "Marin", "San Francisco", 
                    "San Mateo", "Santa Clara", "Solano") 
county_region4 <- c("Amador", "Calaveras", "Madera", "Mariposa", "Merced", 
                     "Mono", "San Joaquin", "Stanislaus", "Tuolumne")
county_region5 <- c("Monterey", "San Benito", "San Luis Obispo", 
                    "Santa Barbara", "Santa Cruz", "Ventura")
county_region6 <- c("Fresno", "Inyo", "Kern", "Kings", "Tulare")
county_region7 <- c("Riverside", "San Bernardino")
county_region8 <- c("Los Angeles")
county_region9 <- c("Orange")
county_region10 <- c("Imperial", "San Diego")

county_geom <- 
  county_geom_raw %>% 
  clean_names() %>% 
  rename(county_name = name) %>% 
  mutate(county_region_name = case_when(county_name %in% county_region1 ~ "Superior California",
                                        county_name %in% county_region2 ~ "North Coast",
                                        county_name %in% county_region3 ~ "San Francisco Bay Area",
                                        county_name %in% county_region4 ~ "Northern San Joaquin Valley",
                                        county_name %in% county_region5 ~ "Central Coast",
                                        county_name %in% county_region6 ~ "Southern San Joaquin Valley",
                                        county_name %in% county_region7 ~ "Inland Empire",
                                        county_name %in% county_region8 ~ "Los Angeles County",
                                        county_name %in% county_region9 ~ "Orange County",
                                        county_name %in% county_region10 ~ "San Diego - Imperial")) %>% 
  mutate(county_region_name = fct_relevel(county_region_name, 
                                          levels = c("Superior California", "North Coast", 
                                                     "San Francisco Bay Area", "Northern San Joaquin Valley", 
                                                     "Central Coast", "Southern San Joaquin Valley", "Inland Empire", 
                                                     "Los Angeles County", "Orange County", "San Diego - Imperial")),
         county_fips = paste0("06", county_fips)) %>% 
  select(county_fips, county_name, geometry, county_region_name)
```

```{r Wrangle income data}
income_data <- 
  income_raw %>% 
  clean_names() %>% 
  rename(county_fips = fips) %>% 
  filter(!grepl(c("06000"), county_fips), # remove CA
         !grepl(c("06003"), county_fips), # remove county not in tree data
         grepl(c(" "), name) # remove empty lines at end of csv
         ) %>% 
  select(county_fips, median_household_income_2019)
```

```{r Wrangling tree data}
tree_data <- 
  tree_canopy_raw %>% 
  clean_names() %>% 
  select(-c(indicator, treecanopy_n, treecanopy_d, notes) # remove empty columns
         ) %>% 
  mutate(county_fips = paste0("0", county_fips))
```

```{r Wrangling covid data}
covid_data <- 
  covid_raw_latimes %>% 
  clean_names() %>% 
  filter(!grepl(c("Alpine"), county)) %>% # remove county not in tree data
  mutate(fips = case_when(fips < 10 ~ paste0("0600", fips),
                          fips < 100 & fips > 10 ~ paste0("060", fips),
                          fips > 100 ~ paste0("06", fips))) %>%
  rename(county_name = county,
         county_fips = fips) %>% 
  mutate(date = as.Date(ymd(date)))
```


## Basic Analysis

For my analysis I planned to conduct a simple linear regression, but first conducted some basic analysis to explore the data. To begin, I did some basic data analysis to create tree canopy and COVID-19 data at the same spatial and temporal resolution. First I calculated the tree canopy cover percentage for each county using the `group_by()` and `summarize()` functions to create an average from the census tract data. Then I calculated each county's average population, average daily number of confirmed positive cases, and average daily reported deaths also using `group_by()` and `summarize()` functions. Finally I calculated a rate of deaths per confirmed case and per capita for each county. Once this was completed, I combined all datasets based on the county Federal Information Processing System (FIPS) codes to create a dataframe including tree canopy, COVID-19, and income data as well as geometries for each county.

```{r County average covid data}
covid_county_average <- 
  covid_data %>% 
  group_by(county_fips) %>% 
  summarise(population_county_av = mean(population),
            confirmed_cases_county_av = mean(confirmed_cases),
            reported_deaths_county_av = mean(reported_deaths)) %>% 
  mutate(deaths_per_case_pct = reported_deaths_county_av / confirmed_cases_county_av,
         deaths_per_pop_pct = reported_deaths_county_av / population_county_av)
```

```{r County average tree data}
tree_county_average <- 
  tree_data %>% 
  group_by(county_fips) %>% 
  summarise(county_treecanopy_pct = mean(treecanopy_pct))
```

```{r Combining data}
full_data_county_average <- 
  left_join(x = covid_county_average, y = tree_county_average, by = "county_fips") %>% 
  left_join(y = county_geom, by = "county_fips") %>% 
  left_join(y = income_data, by = "county_fips")

tree_county_average_sf <- 
  left_join(x = tree_county_average, y = county_geom, by = "county_fips") %>% 
  st_as_sf()

covid_county_average_sf <- 
  left_join(x = covid_county_average, y = county_geom, by = "county_fips") %>% 
  st_as_sf()
```



## Basic Data Visualization

Before deciding to use a simpel linear regression, I wanted to conduct some basic data visualization to explore the correlation between tree canopy and the rate of COVIE-19 deaths per positive case. 

First, I aggregated the county data further into the 10 county regions as defined by the U.S. Census and plotted the canopy cover percentages and COVID-19 deaths per capita for each region (Fig 1). This exploration showed a potential correlation between lower canopied regions within California and COVID-19 deaths per capita. 

```{r Covid county region}
covid_county_region_average <- 
  covid_county_average_sf %>% 
  group_by(county_region_name) %>% 
  summarise(county_region_death_daily_av = mean(reported_deaths_county_av),
            county_region_death_per_case = mean(deaths_per_case_pct),
            county_region_death_daily_av_per_pop = mean(deaths_per_pop_pct))
```

```{r Tree county region}
tree_county_region <- 
  tree_county_average_sf %>% 
  group_by(county_region_name) %>% 
  summarise(county_region_tree_pct = mean(county_treecanopy_pct))
```

```{r Plot county region exploration}
covid_county_region_av_plot <- 
  ggplot(data = covid_county_region_average, 
         aes(x = county_region_death_daily_av, 
             y = county_region_name, 
             fill = county_region_name)) +
  geom_col(show.legend = FALSE)+
  scale_fill_viridis_d() +
  labs(x = "Average Daily COVID Deaths\n(from 2020-02-01 to 2021-11-22)",
       y = "") +
  theme_classic()

covid_county_region_pct_av_plot <- 
  ggplot(data = covid_county_region_average, 
         aes(x = county_region_death_daily_av_per_pop, 
             y = county_region_name, 
             fill = county_region_name)) +
  geom_col(show.legend = FALSE)+
  scale_fill_viridis_d() +
  labs(x = "Average daily COVID deaths per capita \n(from 2020-02-01 to 2021-11-22)",
       y = "") +
  theme_classic()

tree_county_region_plot <- 
  ggplot(data = tree_county_region,
         aes(x = county_region_tree_pct,
             y = county_region_name,
             fill = county_region_name)) +
  geom_col(show.legend = FALSE) +
  scale_fill_viridis_d() +
  labs(x = "Average tree canopy cover percentage\n(from 2011)",
       y = "") +
  theme_classic()
```

```{r fig.align='left', out.width="75%", fig.cap="Plot showing the average tree canopy cover percentage and average daily COVID-19 death per capita for each of California's 10 Census Regions."}
(tree_county_region_plot / covid_county_region_pct_av_plot) + 
  plot_annotation(title = "California County Region Analysis")
```

Next, I honed my exploration more closely in on my research questions: what impact does tree canopy coverage have on the likelihood that someone who contracts COVID-19 will die? To do this I created two maps. One map shows the average tree canopy cover percentage for each county within California (Fig 2). The other map displays the rate of average daily COVID-19 deaths per average daily confirmed positive cases for each county within California (Fig 2). 

```{r tree map viz}
tree_map <- 
  tm_shape(tree_county_average_sf) +
  tm_borders(col = "black", alpha = .65) +
  tm_fill(col = "county_treecanopy_pct",
          style = "cont", 
          n = 5,
          palette ="viridis",
          title = "Tree Canopy Cover\nPercentage") +
  tm_layout(main.title = "Average Tree Canopy Cover\nin CA Counties",
            main.title.size = 1,
            legend.text.size = 0.75, 
            legend.title.size = 0.9)
```

```{r covid map viz}
covid_map <- 
  tm_shape(covid_county_average_sf) +
  tm_borders(col = "black", alpha = .65) +
  tm_fill(col = "deaths_per_case_pct",
          style = "cont", 
          n = 5,
          palette ="viridis",
          title = "Percent of Deaths\nper Positive Case") +
  tm_layout(main.title = "Average COVID Death per Positive Case\nin CA Counties",
            main.title.size = 1,
            legend.text.size = 0.75, 
            legend.title.size = 0.9)
```

```{r fig.align='left', out.width="75%", fig.cap="Maps showing the average tree canopy cover percentage and average daily COVID-19 death per capita for each of the 57 California Counties. (Note: the tree canopy cover data used did not include Alpine County, so it was excluded from all analysis.)", warning=FALSE}
tmap_arrange(tree_map, covid_map)
```


## Simple Linear Regression



Null hypothesis: In California counties, the tree canopy cover percentage has no impact on the rate of COVID deaths per positive reported case.

Alternative hypothesis: In California counties, the tree canopy cover percentage has an impact on the rate of COVID deaths per positive reported case.

```{r Calculate regression model, results=FALSE, message=FALSE}
mod <- lm(deaths_per_case_pct ~ county_treecanopy_pct, data = full_data_county_average)

mod_summary <- summary(mod)
mod_summary
```

```{r Plot regression, fig.align='left', out.width="60%", fig.cap="Correlation plot of tree canopy percentage compared vs. rate of COVID-19 death per positive case for 57 California Counties, including simple linear regression line."}
ggplot(data = full_data_county_average, 
         aes(x = county_treecanopy_pct, 
             y = deaths_per_case_pct)) +
  geom_point() +
  geom_smooth(formula = y ~ x, method = "lm") +
  theme_classic() +
  labs(x = "Tree Canopy Cover (%)",
       y = "COVID Deaths per Positive Case (%)",
       title = "Impacts of Tree Canopy Cover on COVID Deaths per Postive Case \nin California Counties")
```

```{r 95% Confidence interval}
crit_val <- qt(0.025, df = 55, lower.tail = FALSE)

point_est <- mod_summary$coefficients[2, "Estimate"]

SE <- mod_summary$coefficients[2, "Std. Error"]

ci_lower <- round(point_est - (crit_val * SE), 6)
ci_upper <- round(point_est + (crit_val * SE), 6)
```


```{r Calculate regression model controlling for income, eval=FALSE}
#mod_income <- lm(deaths_per_case_pct ~ county_treecanopy_pct + median_household_income_2019, data = full_data_county_average)

#mod_income_summary <- summary(mod_income)
#mod_income_summary
```



## Conclusions and Future Analysis

There is no


## References
#### Data
1. LA Times DataDesk, California Coronavirus Scrapers GitHub repository: https://github.com/datadesk/california-coronavirus-scrapers
2. Public Health Alliance of Southern California's California Healthy Places Index Report: https://healthyplacesindex.org/data-reports/
3. LA Times DataDesk, Geographic Boundaries GitHub repository: https://github.com/datadesk/boundaries.latimes.com/blob/master/shapefiles/counties/2012/counties.prj
4. United States Department of Agriculture Economic Research Service County-level Data Sets: https://www.ers.usda.gov/data-products/county-level-data-sets/
5. United States Census, California Complete Count Office: https://census.ca.gov/regions/

#### Literature
6. 



